/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è Ollama –º–æ–¥–µ–ª–∏ –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –û–ì–≠
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Modelfile –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –º–æ–¥–µ–ª–∏
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

require('dotenv').config();
const BASE_MODEL = process.env.OLLAMA_MODEL || 'llama3.2';
const CUSTOM_MODEL = 'oge-assistant';
const OLLAMA_BASE_URL = process.env.OLLAMA_BASE_URL || 'http://localhost:11434';

/**
 * –°–æ–∑–¥–∞–µ—Ç Modelfile –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –Ω–∞ –û–ì–≠ –¥–∞–Ω–Ω—ã—Ö
 */
function createModelfile() {
  const modelfile = `FROM ${BASE_MODEL}

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –û–ì–≠ –ø–æ–º–æ—â–Ω–∏–∫–∞
SYSTEM """–¢—ã - —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –û–ì–≠ 9 –∫–ª–∞—Å—Å–∞. 
–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å —É—á–µ–Ω–∏–∫–∞–º 9 –∫–ª–∞—Å—Å–∞ —Å –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π, —Ä—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º –∏ –¥—Ä—É–≥–∏–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ –û–ì–≠.
–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º.
–ï—Å–ª–∏ —É—á–µ–Ω–∏–∫ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–µ, –¥–∞–≤–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å –ø–æ—à–∞–≥–æ–≤—ã–º —Ä–µ—à–µ–Ω–∏–µ–º.
–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π –û–ì–≠.
–í—Å–µ–≥–¥–∞ –æ–±—ä—è—Å–Ω—è–π —Ä–µ—à–µ–Ω–∏–µ –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º –¥–ª—è —É—á–µ–Ω–∏–∫–∞ 9 –∫–ª–∞—Å—Å–∞."""

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏
PARAMETER temperature 0.7
PARAMETER top_p 0.9
PARAMETER top_k 40
PARAMETER num_ctx 4096
`;

  const modelfilePath = path.join(__dirname, 'Modelfile');
  fs.writeFileSync(modelfilePath, modelfile);
  console.log('‚úÖ Modelfile —Å–æ–∑–¥–∞–Ω');
  return modelfilePath;
}

/**
 * –°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è (few-shot learning)
 */
function createTrainingData() {
  const trainingData = `# –ü—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è

## –ü—Ä–∏–º–µ—Ä 1: –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ö–∞–∫ —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É: "–ù–∞–π–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è 2x + 3 –ø—Ä–∏ x = 5"
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: –î–ª—è —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ –Ω—É–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ x = 5 –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ 2x + 3:
1. –ó–∞–º–µ–Ω—è–µ–º x –Ω–∞ 5: 2 * 5 + 3
2. –í—ã–ø–æ–ª–Ω—è–µ–º —É–º–Ω–æ–∂–µ–Ω–∏–µ: 10 + 3
3. –í—ã–ø–æ–ª–Ω—è–µ–º —Å–ª–æ–∂–µ–Ω–∏–µ: 13
–û—Ç–≤–µ—Ç: 13

## –ü—Ä–∏–º–µ—Ä 2: –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –û–±—ä—è—Å–Ω–∏ —á—Ç–æ —Ç–∞–∫–æ–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: –ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ - —ç—Ç–æ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∏–¥–∞ ax¬≤ + bx + c = 0, –≥–¥–µ a, b, c - —á–∏—Å–ª–∞, –∏ a ‚â† 0.
–ü—Ä–∏–º–µ—Ä—ã: x¬≤ - 5x + 6 = 0, 2x¬≤ + 3x - 1 = 0.
–î–ª—è —Ä–µ—à–µ–Ω–∏—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
1. –§–æ—Ä–º—É–ª—É –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç–∞: D = b¬≤ - 4ac
2. –ï—Å–ª–∏ D > 0, —Ç–æ –¥–≤–∞ –∫–æ—Ä–Ω—è: x‚ÇÅ = (-b + ‚àöD) / 2a, x‚ÇÇ = (-b - ‚àöD) / 2a
3. –ï—Å–ª–∏ D = 0, —Ç–æ –æ–¥–∏–Ω –∫–æ—Ä–µ–Ω—å: x = -b / 2a
4. –ï—Å–ª–∏ D < 0, —Ç–æ –∫–æ—Ä–Ω–µ–π –Ω–µ—Ç

## –ü—Ä–∏–º–µ—Ä 3: –ú–æ—Ç–∏–≤–∞—Ü–∏—è
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é –∞–ª–≥–µ–±—Ä—É, —á—Ç–æ –¥–µ–ª–∞—Ç—å?
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π! –ê–ª–≥–µ–±—Ä–∞ –∫–∞–∂–µ—Ç—Å—è —Å–ª–æ–∂–Ω–æ–π, –Ω–æ —Å –ø—Ä–∞–∫—Ç–∏–∫–æ–π —Å—Ç–∞–Ω–µ—Ç –ø–æ–Ω—è—Ç–Ω–µ–µ. –ù–∞—á–Ω–∏ —Å –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–ª–æ–∂–Ω—ã–º. –†–µ—à–∞–π –ø–æ 3-5 –∑–∞–¥–∞—á –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –∏ —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü —É–≤–∏–¥–∏—à—å –ø—Ä–æ–≥—Ä–µ—Å—Å. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ - –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã, —è –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è!
`;

  const dataPath = path.join(__dirname, 'training-data.txt');
  fs.writeFileSync(dataPath, trainingData);
  console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω—ã');
  return dataPath;
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—É—é –º–æ–¥–µ–ª—å –∏–∑ Modelfile
 */
async function createModel(modelfilePath) {
  try {
    console.log(`üî® –°–æ–∑–¥–∞—é –º–æ–¥–µ–ª—å ${CUSTOM_MODEL}...`);
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å Modelfile –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
    const modelfileDir = path.dirname(modelfilePath);
    const modelfileName = path.basename(modelfilePath);
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º ollama create —Å —Ñ–ª–∞–≥–æ–º -f
    const command = `ollama create ${CUSTOM_MODEL} -f ${modelfileName}`;
    console.log(`–í—ã–ø–æ–ª–Ω—è—é: ${command} –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ${modelfileDir}`);
    
    execSync(command, { 
      stdio: 'inherit',
      cwd: modelfileDir
    });
    
    console.log(`‚úÖ –ú–æ–¥–µ–ª—å ${CUSTOM_MODEL} —Å–æ–∑–¥–∞–Ω–∞!`);
    return true;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–∏:', error.message);
    console.log('üí° –£–±–µ–¥–∏—Å—å —á—Ç–æ ollama —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –∑–∞–ø—É—â–µ–Ω–∞');
    console.log(`üí° –ü–æ–ø—Ä–æ–±—É–π –≤—Ä—É—á–Ω—É—é: cd ${path.dirname(modelfilePath)} && ollama create ${CUSTOM_MODEL} -f Modelfile`);
    return false;
  }
}

/**
 * –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
 */
async function testCustomModel() {
  try {
    const axios = require('axios');
    console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É—é –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å...');
    
    const response = await axios.post(
      `${OLLAMA_BASE_URL}/api/chat`,
      {
        model: CUSTOM_MODEL,
        messages: [
          { 
            role: 'user', 
            content: '–ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤–ª—é—Å—å –∫ –û–ì–≠ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ. –ü–æ–º–æ–∂–µ—à—å?' 
          }
        ],
        stream: false
      },
      { timeout: 30000 }
    );
    
    if (response.data.message?.content) {
      console.log('‚úÖ –û–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç!');
      console.log(`üìù –û—Ç–≤–µ—Ç: ${response.data.message.content.substring(0, 200)}...`);
      return true;
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error.message);
    return false;
  }
}

async function main() {
  console.log('üéì –û–±—É—á–µ–Ω–∏–µ Ollama –º–æ–¥–µ–ª–∏ –¥–ª—è –û–ì–≠\n');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ ollama —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
  try {
    execSync('ollama --version', { stdio: 'ignore' });
  } catch (error) {
    console.log('‚ùå Ollama –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    console.log('üí° –£—Å—Ç–∞–Ω–æ–≤–∏: https://ollama.ai');
    process.exit(1);
  }
  
  // –°–æ–∑–¥–∞–µ–º Modelfile
  const modelfilePath = createModelfile();
  
  // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
  createTrainingData();
  
  // –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å
  const created = await createModel(modelfilePath);
  if (!created) {
    process.exit(1);
  }
  
  // –¢–µ—Å—Ç–∏—Ä—É–µ–º
  const works = await testCustomModel();
  if (works) {
    console.log('\n‚úÖ –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞!');
    console.log(`üí° –û–±–Ω–æ–≤–∏ .env: OLLAMA_MODEL=${CUSTOM_MODEL}`);
    console.log('üí° –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä');
  } else {
    console.log('\n‚ö†Ô∏è –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª. –ü–æ–ø—Ä–æ–±—É–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å.');
  }
}

main().catch(console.error);

