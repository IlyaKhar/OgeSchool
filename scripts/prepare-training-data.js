/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –Ω–∞ –û–ì–≠ –∑–∞–¥–∞–Ω–∏—è—Ö
 * –°–æ–∑–¥–∞–µ—Ç JSONL —Ñ–∞–π–ª —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –¥–∏–∞–ª–æ–≥–æ–≤
 */

const fs = require('fs');
const path = require('path');
const Database = require('better-sqlite3');

// –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –∑–∞–¥–∞–Ω–∏–π
const dbPath = path.join(__dirname, '../database/tasks.db');
const db = new Database(dbPath);

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–∏–º–µ—Ä—ã –∑–∞–¥–∞–Ω–∏–π –∏–∑ –±–∞–∑—ã
 */
function getTaskExamples(limit = 10) {
  try {
    const tasks = db.prepare(`
      SELECT 
        t.id,
        t.question_text,
        t.correct_answer,
        t.explanation,
        t.solution_steps,
        s.name as subject_name,
        top.name as topic_name
      FROM tasks t
      LEFT JOIN subjects s ON t.subject_id = s.id
      LEFT JOIN topics top ON t.topic_id = top.id
      WHERE t.explanation IS NOT NULL
      LIMIT ?
    `).all(limit);

    return tasks;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π:', error);
    return [];
  }
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
 */
function createTrainingExamples() {
  const examples = [];
  
  // –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
  examples.push({
    messages: [
      {
        role: "system",
        content: "–¢—ã - —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –û–ì–≠ 9 –∫–ª–∞—Å—Å–∞. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å —É—á–µ–Ω–∏–∫–∞–º 9 –∫–ª–∞—Å—Å–∞ —Å –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π, —Ä—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º –∏ –¥—Ä—É–≥–∏–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ –û–ì–≠. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º."
      },
      {
        role: "user",
        content: "–ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤–ª—é—Å—å –∫ –û–ì–≠ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ. –ü–æ–º–æ–∂–µ—à—å?"
      },
      {
        role: "assistant",
        content: "–ü—Ä–∏–≤–µ—Ç! –ö–æ–Ω–µ—á–Ω–æ, –ø–æ–º–æ–≥—É! –Ø –∑–¥–µ—Å—å —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –û–ì–≠ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ. –ú–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å —Ç–µ–º—ã, —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏, —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—à–∏–±–∫–∏. –ß—Ç–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? –ú–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –ª—é–±–æ–π —Ç–µ–º–µ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã 9 –∫–ª–∞—Å—Å–∞."
      }
    ]
  });

  examples.push({
    messages: [
      {
        role: "system",
        content: "–¢—ã - —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –û–ì–≠ 9 –∫–ª–∞—Å—Å–∞."
      },
      {
        role: "user",
        content: "–ö–∞–∫ —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É: –ù–∞–π–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è 2x + 3 –ø—Ä–∏ x = 5"
      },
      {
        role: "assistant",
        content: "–î–ª—è —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ –Ω—É–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ x = 5 –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ 2x + 3:\n\n1. –ó–∞–º–µ–Ω—è–µ–º x –Ω–∞ 5: 2 * 5 + 3\n2. –í—ã–ø–æ–ª–Ω—è–µ–º —É–º–Ω–æ–∂–µ–Ω–∏–µ: 10 + 3\n3. –í—ã–ø–æ–ª–Ω—è–µ–º —Å–ª–æ–∂–µ–Ω–∏–µ: 13\n\n**–û—Ç–≤–µ—Ç: 13**\n\n–≠—Ç–æ –ø—Ä–æ—Å—Ç–∞—è –∑–∞–¥–∞—á–∞ –Ω–∞ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫—É –∑–Ω–∞—á–µ–Ω–∏–π –≤ –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ. –ì–ª–∞–≤–Ω–æ–µ - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É."
      }
    ]
  });

  examples.push({
    messages: [
      {
        role: "system",
        content: "–¢—ã - —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –û–ì–≠ 9 –∫–ª–∞—Å—Å–∞."
      },
      {
        role: "user",
        content: "–û–±—ä—è—Å–Ω–∏ —á—Ç–æ —Ç–∞–∫–æ–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è"
      },
      {
        role: "assistant",
        content: "–ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ - —ç—Ç–æ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∏–¥–∞ **ax¬≤ + bx + c = 0**, –≥–¥–µ a, b, c - —á–∏—Å–ª–∞ (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã), –∏ **a ‚â† 0**.\n\n**–ü—Ä–∏–º–µ—Ä—ã:**\n- x¬≤ - 5x + 6 = 0\n- 2x¬≤ + 3x - 1 = 0\n- 3x¬≤ - 12 = 0\n\n**–ö–∞–∫ —Ä–µ—à–∞—Ç—å:**\n1. –ù–∞—Ö–æ–¥–∏–º –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç: **D = b¬≤ - 4ac**\n2. –ï—Å–ª–∏ D > 0, —Ç–æ –¥–≤–∞ –∫–æ—Ä–Ω—è:\n   - x‚ÇÅ = (-b + ‚àöD) / 2a\n   - x‚ÇÇ = (-b - ‚àöD) / 2a\n3. –ï—Å–ª–∏ D = 0, —Ç–æ –æ–¥–∏–Ω –∫–æ—Ä–µ–Ω—å: x = -b / 2a\n4. –ï—Å–ª–∏ D < 0, —Ç–æ –∫–æ—Ä–Ω–µ–π –Ω–µ—Ç\n\n**–ü—Ä–∏–º–µ—Ä:** –†–µ—à–∏–º x¬≤ - 5x + 6 = 0\n- a = 1, b = -5, c = 6\n- D = (-5)¬≤ - 4*1*6 = 25 - 24 = 1\n- x‚ÇÅ = (5 + 1) / 2 = 3\n- x‚ÇÇ = (5 - 1) / 2 = 2\n\n**–û—Ç–≤–µ—Ç: x = 2 –∏–ª–∏ x = 3**"
      }
    ]
  });

  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
  const tasks = getTaskExamples(20); // –£–≤–µ–ª–∏—á–∏–ª–∏ —Å 5 –¥–æ 20
  tasks.forEach(task => {
    if (task.explanation) {
      // –†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
      const questionFormats = [
        `–ö–∞–∫ —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ ${task.subject_name}${task.topic_name ? ` (${task.topic_name})` : ''}:\n${task.question_text}`,
        `–ü–æ–º–æ–≥–∏ —Ä–µ—à–∏—Ç—å:\n${task.question_text}`,
        `–û–±—ä—è—Å–Ω–∏ –∫–∞–∫ —Ä–µ—à–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É:\n${task.question_text}`,
        `${task.question_text}\n–ö–∞–∫ —ç—Ç–æ —Ä–µ—à–∏—Ç—å?`
      ];
      
      const randomFormat = questionFormats[Math.floor(Math.random() * questionFormats.length)];
      
      examples.push({
        messages: [
          {
            role: "system",
            content: "–¢—ã - —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –û–ì–≠ 9 –∫–ª–∞—Å—Å–∞. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å —É—á–µ–Ω–∏–∫–∞–º 9 –∫–ª–∞—Å—Å–∞ —Å –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π, —Ä—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º –∏ –¥—Ä—É–≥–∏–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ –û–ì–≠. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º."
          },
          {
            role: "user",
            content: randomFormat
          },
          {
            role: "assistant",
            content: `${task.explanation}\n\n${task.solution_steps ? '**–ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**\n' + task.solution_steps.split(',').map((step, i) => `${i+1}. ${step.trim()}`).join('\n') : ''}\n\n**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:** ${task.correct_answer}`
          }
        ]
      });
    }
  });

  return examples;
}

/**
 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSONL —Ñ–æ—Ä–º–∞—Ç
 */
function saveTrainingData(examples, filename = 'training-data.jsonl') {
  const filePath = path.join(__dirname, filename);
  const lines = examples.map(ex => JSON.stringify(ex)).join('\n');
  fs.writeFileSync(filePath, lines);
  console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ${filePath}`);
  console.log(`üìä –ü—Ä–∏–º–µ—Ä–æ–≤: ${examples.length}`);
  return filePath;
}

async function main() {
  console.log('üìö –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –û–ì–≠\n');
  
  const examples = createTrainingExamples();
  const filePath = saveTrainingData(examples);
  
  console.log('\n‚úÖ –ì–æ—Ç–æ–≤–æ!');
  console.log(`üí° –§–∞–π–ª: ${filePath}`);
  console.log('üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è fine-tuning');
  console.log('\n–î–ª—è –æ–±—É—á–µ–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏: npm run train-ollama');
  
  db.close();
}

main().catch(console.error);

